<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo de Marcas y Tiendas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-gray: #f5f5f5;
            --border-color: #ddd;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: #333;
        }
        
        .mapa-container {
            display: flex;
            max-width: 1200px;
            margin: 20px auto;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .categorias-mapa {
            width: 300px;
            background-color: white;
            padding: 20px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            max-height: 600px;
        }
        
        .categorias-mapa h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }
        
        .categoria-grupo {
            margin-bottom: 25px;
        }
        
        .categoria-grupo h3 {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .categoria-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .categoria-item:hover {
            background-color: var(--light-gray);
        }
        
        .categoria-item.activa {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .categoria-icono {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .categoria-icono img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .categoria-item.activa .categoria-icono {
            background-color: transparent;
        }
        
        .mapa-visualizacion {
            flex: 1;
            height: 600px;
            position: relative;
        }
        
        #mapa-marcas {
            width: 100%;
            height: 100%;
        }
        
        .mapa-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .mapa-controls button {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .mapa-controls button:hover {
            background: #2980b9;
        }
                
        .marcador-personalizado {
            transition: transform 0.2s ease-in-out;
        }
        .marcador-personalizado:hover {
            transform: scale(1.4);
        }

        .popup-personalizado { min-width: 200px; }
        .popup-personalizado h3 { color: var(--primary-color); margin-bottom: 5px; }
        .popup-personalizado p { margin-bottom: 5px; font-size: 0.9rem; }
        .popup-personalizado .categoria { display: inline-block; background: var(--secondary-color); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-top: 5px; }
        
        @media (max-width: 768px) {
            .mapa-container { flex-direction: column; }
            .categorias-mapa { width: 100%; max-height: 250px; border-right: none; border-bottom: 1px solid var(--border-color); }
            .mapa-visualizacion { height: 400px; }
        }
    </style>
</head>
<body>
    <div class="mapa-container">
        <div class="categorias-mapa">
            <h2>Marcas y Tiendas</h2>
            <div id="filtros-dinamicos-container"></div>
        </div>
        
        <div class="mapa-visualizacion">
            <div id="mapa-marcas"></div>
            <div class="mapa-controls">
                <button id="btn-mostrar-todos">Mostrar Todos</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- CONFIGURACIÓN ---
            const mapboxAccessToken = 'pk.eyJ1IjoibGlzcGlyYXppb25lIiwiYSI6ImNsdWl1YnNhNjAybnAybHFwYjRkOXJteW4ifQ.DwmRzbofSWiVTmAGM3o9Rw';
            const mapboxStyleId = 'lispirazione/cmgjz4si1002m01qm4j2sdwa7';
            const defaultIconUrl = 'https://sinbio.web-305.com/wp-content/uploads/2025/10/marcador-az.svg';

            // --- INICIALIZACIÓN DEL MAPA ---
            const mapa = L.map('mapa-marcas').setView([23.6, -102.5], 5);
            L.tileLayer(`https://api.mapbox.com/styles/v1/${mapboxStyleId}/tiles/{z}/{x}/{y}?access_token=${mapboxAccessToken}`, {
                attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a>',
                maxZoom: 18, tileSize: 512, zoomOffset: -1
            }).addTo(mapa);
            const capaMarcadores = L.layerGroup().addTo(mapa);

            // --- CARGA DE DATOS Y CONSTRUCCIÓN DEL MAPA ---
            async function initializeMap() {
                try {
                    const [marcas, allPoints] = await Promise.all([
                        loadAllTerms('maptype'),
                        loadAllPosts('jet-map')
                    ]);

                    const iconosPorTerminoID = {};
                    marcas.forEach(marca => {
                        if (marca.meta && marca.meta.icono_marca) {
                            iconosPorTerminoID[marca.id] = marca.meta.icono_marca;
                        }
                    });
                    
                    buildAndDisplayFilters(marcas, iconosPorTerminoID);
                    displayMarkers(allPoints, iconosPorTerminoID);

                } catch (error) {
                    console.error("Error al inicializar el mapa:", error);
                }
            }

            // --- FUNCIONES AUXILIARES ---
            
            // --- ESTA ES LA FUNCIÓN CORREGIDA ---
            async function loadAllPosts(postType) {
                // 1. Hacemos una primera solicitud solo para obtener los encabezados (headers)
                const initialResponse = await fetch(`/wp-json/wp/v2/${postType}?per_page=1&_embed`);
                
                if (!initialResponse.ok) {
                    throw new Error("No se pudo conectar a la API de posts.");
                }

                // 2. Leemos el número TOTAL de posts (ej: 582)
                const totalPosts = parseInt(initialResponse.headers.get('X-WP-Total'));
                
                // 3. Calculamos el número TOTAL de páginas (ej: 6)
                const totalPages = Math.ceil(totalPosts / 100);
                
                if (isNaN(totalPages) || totalPages === 0) {
                    console.warn("No se encontraron posts o páginas.");
                    return [];
                }
                
                console.log(`Se encontraron ${totalPosts} posts en ${totalPages} páginas.`);

                const fetchPromises = [];
                // 4. Creamos un bucle que itera el número de PÁGINAS (ej: 6 veces)
                for (let page = 1; page <= totalPages; page++) {
                    fetchPromises.push(
                        fetch(`/wp-json/wp/v2/${postType}?per_page=100&page=${page}&_embed`)
                            .then(res => {
                                if (!res.ok) {
                                    console.error(`Error al cargar la página ${page}. Estado: ${res.status}`);
                                    return []; // Devuelve un array vacío si esta página falla
                                }
                                return res.json();
                            })
                            .catch(err => {
                                console.error(`Error de red en página ${page}:`, err);
                                return []; // Devuelve un array vacío en caso de error de red
                            })
                    );
                }
                
                // 5. Esperamos a que todas las solicitudes (las 6) terminen
                const results = await Promise.all(fetchPromises);
                
                // 6. Unimos los resultados de todas las páginas en un solo array
                const allPosts = results.flat();
                console.log(`Se cargaron ${allPosts.length} posts en total.`);
                return allPosts;
            }

            async function loadAllTerms(taxonomy) {
                const response = await fetch(`/wp-json/wp/v2/${taxonomy}?per_page=100`);
                 if (!response.ok) {
                    console.error("Error al cargar las taxonomías (categorías).");
                    return [];
                }
                const text = await response.text();
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.error("Error al parsear la respuesta de la taxonomía:", text);
                    return [];
                }
            }

            function buildAndDisplayFilters(marcas, iconosPorTerminoID) {
                const container = document.getElementById('filtros-dinamicos-container');
                container.innerHTML = '';
                
                const buildHierarchy = (list) => {
                    const map = {};
                    const roots = [];
                    list.forEach(item => { map[item.id] = { ...item, children: [] }; });
                    list.forEach(item => {
                        if (item.parent) map[item.parent]?.children.push(map[item.id]);
                        else roots.push(map[item.id]);
                    });
                    return roots;
                };

                const hierarchicalMarcas = buildHierarchy(marcas);
                
                hierarchicalMarcas.forEach(parentCategory => {
                    if (parentCategory.children.length > 0) {
                        const group = document.createElement('div');
                        group.className = 'categoria-grupo';
                        
                        let groupHTML = `<h3>${parentCategory.name}</h3>`;
                        
                        parentCategory.children.forEach(childCategory => {
                            const iconUrl = iconosPorTerminoID[childCategory.id] || defaultIconUrl;
                            groupHTML += `
                                <div class="categoria-item" data-categoria="${childCategory.slug}">
                                    <div class="categoria-icono">
                                        <img src="${iconUrl}" alt="${childCategory.name}">
                                    </div>
                                    <span>${childCategory.name}</span>
                                </div>
                            `;
                        });
                        
                        group.innerHTML = groupHTML;
                        container.appendChild(group);
                    }
                });
                
                addFilterListeners();
            }

            function displayMarkers(points, iconosPorTerminoID) {
                capaMarcadores.clearLayers();
                points.forEach(point => {
                    const ubicacion = point.meta?.jet_ubicacion;
                    const terms = point._embedded?.['wp:term']?.[0] || [];
                    
                    if (ubicacion && ubicacion.lat && terms.length > 0) {
                        const term = terms[0];
                        const iconUrl = iconosPorTerminoID[term.id] || defaultIconUrl;

                        const customIcon = L.icon({
                            iconUrl: iconUrl,
                            iconSize: [40, 40],
                            iconAnchor: [20, 40],
                            className: 'marcador-personalizado'
                        });

                        const marker = L.marker([ubicacion.lat, ubicacion.lng], { icon: customIcon });
                        
                        marker.bindPopup(`
                            <div class="popup-personalizado">
                                <h3>${point.title.rendered}</h3>
                                ${point.meta?.jet_enlace_marcador ? `<p><a href="${point.meta.jet_enlace_marcador}" target="_blank">Ver más</a></p>` : ''}
                                <span class="categoria">${term.name}</span>
                            </div>
                        `);

                        marker._categoria = term.slug;
                        marker.addTo(capaMarcadores);
                    }
                });
            }

            function addFilterListeners() {
                const categoryItems = document.querySelectorAll('.categoria-item');
                categoryItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const wasActive = this.classList.contains('activa');
                        categoryItems.forEach(el => el.classList.remove('activa'));
                        
                        if (!wasActive) {
                            this.classList.add('activa');
                            const selectedCategory = this.getAttribute('data-categoria');
                            
                            capaMarcadores.eachLayer(marker => {
                                if (marker._categoria === selectedCategory) {
                                    marker.addTo(mapa);
                                } else {
                                    mapa.removeLayer(marker);
                                }
                            });
                        } else {
                            document.getElementById('btn-mostrar-todos').click();
                        }
                    });
                });
            }

            document.getElementById('btn-mostrar-todos').addEventListener('click', function() {
                capaMarcadores.eachLayer(marker => {
                    marker.addTo(mapa);
                });
                document.querySelectorAll('.categoria-item').forEach(el => el.classList.remove('activa'));
                mapa.setView([23.6, -102.5], 5);
            });
            
            initializeMap();
        });
    </script>
</body>
</html>
